# HDFS
HDFS是Hadoop的旗舰级文件系统
## HDFS的设计
以流式数据访问模式来存储超大文件  
* 流式数据访问 HDFS思路：一次写入、多次读取是最高效的访问模式
## HDFS的概念
### 数据块
磁盘有块概念，是磁盘进行数据读写的最小单位，文件系统块一般为几千字节，而磁盘块一般为512字节。  
HDFS也有block概念，大得多，默认为128MB，HDFS上的文件也被划分为块大小的多个分块(chunk)，作为独立的存储单元。但与磁盘不同，
HDFS中小于一个block的文件不会占据整个块的空间。  
**目的：** 最小化寻址开销  
与磁盘文件系统相似，HDFS中的fsck指令可以显示块信息  
`hdfs fsck / -files -blocks`  
### namenode和datanode
管理节点(namenode)-工作节点(datanode)工作模式；namenode管理文件系统的命名空间。它维护者文件系统树及整棵树内所有的文件和目录。
这些信息以两个文件形式永久保存在本地磁盘上：命名空间镜像文件和编辑日志文件。namenode也记录着每个文件中各个块所在的数据节点信息，
但它并不永久保存块的位置信息，因为这些信息会在系统启动时根据数据节点信息重建。  
**namenode非常重要！！** 因此要有容错机制：  
* 1.备份那些组成文件系统元数据持久状态的文件。Hadoop可以通过配置使namenode在多个文件系统上保存元数据的持久状态。这些写操作是
实时同步的，且是原子操作。一般的配置是，在持久状态写入本地磁盘的同时，写入一个远程挂载的网络文件系统NFS。  
* 2.运行一个辅助namenode，但它不能被用作namenode。这个辅助namenode的重要作用是定期合并编辑日志与命名空间镜像，以防止编辑日志
过大。这个辅助namenode一般在另一台单独的物理计算机上运行，因为它需要占用大量CPU时间，并且需要与namenode一样多的内存来执行合并
操作。它会保存合并后的命名空间镜像的副本，并且在namenode发生故障时启用。但是，辅助namenode保存的状态总是滞后于主节点，所以
在主节点全部失效时，难免会丢失部分数据。  
### 块缓存
通常datanode从磁盘中读取块，但对于访问频繁的文件，其对应的块可能被显式地缓存在datanode的内存中，以堆外块缓存(off-heap block cache)
的形式存在。默认情况，一个块仅缓存在一个datanode的内存中，当然可以针每个文件配置datanode的数量。作业调度器（用于MapReduce、Spark
和其他框架的）通过在缓存块的datanode上运行任务，可以利用块缓存的优势提高读操作的性能。缓存池是一个用于管理缓存权限和资源使用的管理
性分组。  
### 联邦HDFS
联邦HDFS允许通过添加namenode实现扩展命名空间中的一部分。例如，一个namenode可能管理/user目录下的所有文件，而另一个namenode可能管理
/share目录下的所有文件。  
联邦环境下，每个namenode维护一个命名空间卷(namespace volume),由命名空间的元数据和一个数据块池(block pool)组成，数据块池包含该命名
空间下文件的所有数据块。命名空间卷之间是相互独立的，两两之间并不相互通信，甚至其中一个namenode的失效也不会影响由其他namenode维护的命名
空间的可用性。
### HDFS高可用性
新的namenode知道满足一下情形才能响应服务:  
1. 将命名空间的映像导入内存中
2. 重演编辑日志
3. 接收到足够多的来自datenode的数据块报告并退出安全模式  
对于一个大型并拥有大量文件和数据块的集群，namenode的冷启动需要30分钟，甚至更长  
两种高可用性共享存储:**NFS过滤器或群体日志管理器QJM**  
QJM是一个专用的HDFS实现，为提供一个高可用的编辑日志而设计，QJM以一组日志节点的形式运行，每一次编辑必须写入多数日志节点。  
